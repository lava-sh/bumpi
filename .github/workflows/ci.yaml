name: "CI"

permissions: { }

on:
  push:
    branches:
      - main
    tags:
      - "*"
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:
  zizmor:
    name: "zizmor"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.13"
      - name: "Install uv"
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
        with:
          enable-cache: ${{ !startsWith(github.ref, 'refs/tags/') }} # zizmor: ignore[cache-poisoning]
      - name: "Install zizmor"
        run: uv pip install --group zizmor --system
      - name: "Run zizmor"
        run: zizmor .github/

  typos:
    name: "typos"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.13"
      - name: "Install uv"
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
        with:
          enable-cache: ${{ !startsWith(github.ref, 'refs/tags/') }} # zizmor: ignore[cache-poisoning]
      - name: "Install typos"
        run: uv pip install --group typos --system
      - name: "Run typos"
        run: typos

  tests:
    name: "${{ matrix.os }} / python ${{ matrix.python-version }}"
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        python-version:
          - "3.13"
        os: [
          ubuntu-latest,
          windows-latest,
        ]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: ${{ matrix.python-version }}
      - name: "Install uv"
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
        with:
          enable-cache: ${{ !startsWith(github.ref, 'refs/tags/') }} # zizmor: ignore[cache-poisoning]
      - name: "Create and activate .venv"
        shell: bash
        run: |
          uv venv .venv --python ${{ matrix.python-version }}
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            echo ".venv/Scripts" >> "$GITHUB_PATH"
          else
            echo ".venv/bin" >> "$GITHUB_PATH"
          fi
      - name: "Install dependencies"
        run: |
          uv pip install --group ci
      - name: "Run Ruff"
        run: |
          ruff check
      - name: "Run Ruff"
        run: |
          ty check
      - name: "Run pytest"
        run: |
          pytest tests/
